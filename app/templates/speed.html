{% extends "base.html" %}

{% block title %}Speed Game{% endblock %}

{% block header_title %}Speed Game{% endblock %}

{% block content %}
<div class="game-container">
    <h1>Speed Game</h1>
    <p>Click the circles as quickly as you can before they disappear!</p>

    <div class="game-area" id="gameArea"></div>
    
    <div class="timer" id="timer">Time: 30s</div>
    
    <div class="stats">
        <div class="stat-item">
            <i class="fas fa-check"></i> Hits: <span id="hits">0</span>
        </div>
        <div class="stat-item">
            <i class="fas fa-times"></i> Misses: <span id="misses">0</span>
        </div>
    </div>

    <button class="start-button" id="startButton">Start Game</button>
</div>

<style>
    .game-container {
        max-width: 800px;
        margin: 8rem auto 4rem;
        padding: 2rem;
        background: var(--card-background);
        border-radius: 1.5rem;
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
        text-align: center;
    }

    .game-area {
        width: 100%;
        height: 400px;
        background: linear-gradient(135deg, rgba(124, 58, 237, 0.05), rgba(244, 114, 182, 0.05));
        border-radius: 1rem;
        position: relative;
        margin: 2rem 0;
        overflow: hidden;
    }

    .circle {
        position: absolute;
        border-radius: 50%;
        cursor: pointer;
        transition: all 0.3s ease;
        background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }

    .circle:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
    }

    .score-display {
        font-size: 1.5rem;
        margin: 1rem 0;
        color: var(--primary-color);
    }

    .timer {
        font-size: 2rem;
        font-weight: bold;
        color: var(--primary-color);
        margin: 1rem 0;
    }

    .stats {
        display: flex;
        justify-content: center;
        gap: 2rem;
        margin: 1rem 0;
        font-size: 1.2rem;
    }

    .stat-item {
        padding: 0.5rem 1rem;
        background: linear-gradient(135deg, rgba(124, 58, 237, 0.1), rgba(244, 114, 182, 0.1));
        border-radius: 0.5rem;
    }

    .start-button {
        padding: 1rem 2rem;
        font-size: 1.2rem;
        background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
        color: white;
        border: none;
        border-radius: 0.75rem;
        cursor: pointer;
        transition: all 0.3s ease;
        margin: 1rem 0;
    }

    .start-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
    }

    .start-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
    }
</style>

<script>
    const gameArea = document.getElementById('gameArea');
    const timerDisplay = document.getElementById('timer');
    const hitsDisplay = document.getElementById('hits');
    const missesDisplay = document.getElementById('misses');
    const startButton = document.getElementById('startButton');

    let hits = 0;
    let misses = 0;
    let timeLeft = 30;
    let gameInterval;
    let circleInterval;
    let isGameRunning = false;

    function createCircle() {
        const circle = document.createElement('div');
        circle.className = 'circle';
        
        // Random size between 30px and 100px
        const size = Math.random() * 70 + 30;
        circle.style.width = `${size}px`;
        circle.style.height = `${size}px`;
        
        // Random position within game area
        const maxX = gameArea.clientWidth - size;
        const maxY = gameArea.clientHeight - size;
        circle.style.left = `${Math.random() * maxX}px`;
        circle.style.top = `${Math.random() * maxY}px`;
        
        // Random display time between 1s and 3s
        const displayTime = Math.random() * 2000 + 1000;
        
        circle.addEventListener('click', () => {
            if (isGameRunning) {
                hits++;
                hitsDisplay.textContent = hits;
                circle.remove();
            }
        });
        
        gameArea.appendChild(circle);
        
        // Remove circle after display time
        setTimeout(() => {
            if (circle.parentNode === gameArea) {
                misses++;
                missesDisplay.textContent = misses;
                circle.remove();
            }
        }, displayTime);
    }

    function startGame() {
        // Reset game state
        hits = 0;
        misses = 0;
        timeLeft = 30;
        hitsDisplay.textContent = '0';
        missesDisplay.textContent = '0';
        startButton.disabled = true;
        isGameRunning = true;
        
        // Clear any existing circles
        gameArea.innerHTML = '';
        
        // Start timer
        gameInterval = setInterval(() => {
            timeLeft--;
            timerDisplay.textContent = `Time: ${timeLeft}s`;
            
            if (timeLeft <= 0) {
                endGame();
            }
        }, 1000);
        
        // Start creating circles
        circleInterval = setInterval(createCircle, 1000);
    }

    function saveScore(hits, total) {
        // Only save if user is logged in
        if (document.body.classList.contains('logged-in')) {
            fetch('/save_score', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    game_type: 'Speed Game',
                    score: hits,
                    total: total
                })
            });
        }
    }

    function endGame() {
        isGameRunning = false;
        clearInterval(gameInterval);
        startButton.disabled = false;
        
        // Clear game area
        gameArea.innerHTML = '';
        
        // Calculate final score and save it
        const totalAttempts = hits + misses;
        const accuracy = ((hits / totalAttempts) * 100).toFixed(1);
        saveScore(hits, totalAttempts);
        
        // Show final score
        timerDisplay.textContent = `Game Over! Accuracy: ${accuracy}%`;
    }

    startButton.addEventListener('click', startGame);
</script>
{% endblock %}
